<div class="p-4">
  <sc-title [title]="'Enquiry Items'"></sc-title>
</div>

<div class="ms-5 me-5 ps-5">
  <dx-data-grid
    [dataSource]="enquiries$ | async"
    [showBorders]="true"
    [columnAutoWidth]="true"
    [allowColumnReordering]="true"
    [filterRow]="{ visible: true }"
    [paging]="{ enabled: true, pageSize: 10 }"
    [groupPanel]="{ visible: true }"
    [grouping]="{ autoExpandAll: true }"
    [sorting]="{ mode: 'multiple' }"
    [selection]="{ mode: 'single' }"
  >
    <!-- Column Chooser -->
    <dxo-column-chooser [enabled]="true" mode="dragAndDrop"></dxo-column-chooser>
    <dxo-paging
      [enabled]="true"
      [pageSize]="5"
      [pageIndex]="1"
    >
    </dxo-paging>
    <dxo-pager
      [visible]="true"
      [displayMode]="'full'"
      [showInfo]="true"
      [showPageSizeSelector]="true"
      [allowedPageSizes]="[10, 20, 50]"
      infoText="Page #{0}. Total: {1} ({2} items)"
      [showNavigationButtons]="true">
    </dxo-pager>

    <!-- Load Panel -->
    <dxo-load-panel [enabled]="true"></dxo-load-panel>

    <!-- Define columns for Enquiry Data -->
    <dxi-column dataField="enquiryId" caption="Enquiry ID" [width]="100"></dxi-column>
    <dxi-column dataField="regarding" caption="Regarding" [width]="400"></dxi-column>
    <dxi-column dataField="requiresReply" caption="Requires Reply" [width]="150"></dxi-column>
    <dxi-column dataField="sender" caption="Sender" [width]="150"></dxi-column>
    <dxi-column dataField="enquiryDate" caption="Enquiry Date" [dataType]="'date'" [format]="{ type: 'shortDate' }" [width]="150"></dxi-column>

    <!-- Edit and Delete Buttons -->
    <dxi-column caption="View Detail" [width]="130" [cellTemplate]="'editButtonTemplate'" >
      <div *dxTemplate="let data of 'editButtonTemplate'">
        <dx-button type="success" text="View Detail" (onClick)="navigateToDetail(data)" ></dx-button>
      </div>
    </dxi-column>

    <!-- **New: Open Modal Button** -->
    <dxi-column caption="Send Enquiry" [width]="130">
      <div *dxTemplate="let data of 'cellTemplate'">
        <dx-button text="Send Enquiry" type="default" (onClick)="openModal(data)"></dx-button>
      </div>
    </dxi-column>
  </dx-data-grid>

  <dx-popup
    [(visible)]="isModalVisible"
    [width]="600"
    [height]="auto"
    [showTitle]="true"
    title="Send Enquiry"
    [dragEnabled]="false"
    [closeOnOutsideClick]="true">

    <dx-form
      [formData]="formData"
      [colCount]="1"
      (onSubmit)="onFormSubmit($event)">

      <dxi-item
        dataField="enquiry_type_id"
        editorType="dxSelectBox"
        [editorOptions]="{
        dataSource: enquiryTypeDataSource,
        displayExpr: 'enquiry_name',
        valueExpr: 'enquiry_type_id',
        disabled: isDisabled
      }"
        [isRequired]="true"
        label="Enquiry Type">
      </dxi-item>

      <dxi-item *ngIf="isUserInternal"
                dataField="receiver_user_id"
                editorType="dxSelectBox"
                [editorOptions]="{
        dataSource: customersDataSource,
        displayExpr: 'name',
        valueExpr: 'user_id',
        disabled: isDisabled
      }"
                [isRequired]="true"
                label="Customer">
      </dxi-item>

      <dxi-item
        dataField="message_content"
        editorType="dxTextArea"
        [editorOptions]="{ height: 90 }"
        [isRequired]="true"
        label="Message">
      </dxi-item>

      <!-- Hidden Fields -->
      <input type="hidden" name="sender_user_id" [value]="getCurrentUserId()" />
      <input type="hidden" name="receiver_user_id" value="" />

      <dxi-item>
        <dx-button
          text="Send"
          type="success"
          useSubmitBehavior="true">
        </dx-button>
      </dxi-item>

    </dx-form>
  </dx-popup>

</div>
